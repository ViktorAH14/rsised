#!/bin/bash

#########################################################################################
# File: install.sh                                                                      #
#                                                                                       #
# Description: #
#                                                                                       #
# Created:                                                                  #
#                                                                                       #
# Copyright: (c) 2022 by Viktor Ermolov <ermolovva@gmail.com>.                          #
#                                                                                       #
# This file is part of the RSiSed project, a editor of the alignment of forces          #
# and means in extinguishing a fire. (RSiSed)                                           #
#                                                                                       #
# RSiSed is free software: you can redistribute it and/or modify                        #
# it under the terms of the GNU General Public License as published by                  #
# the Free Software Foundation, either version 3 of the License, or                     #
# (at your option) any later version.                                                   #
#                                                                                       #
# RSiSed is distributed in the hope that it will be useful,                             #
# but WITHOUT ANY WARRANTY; without even the implied warranty of                        #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the                          #
# GNU General Public License for more details.                                          #
#                                                                                       #
# You should have received a copy of the GNU General Public License                     #
# along with this program.  If not, see <https://www.gnu.org/licenses/>.                #
#                                                                                       #
# Email: <ermolovva@gmail.com>                                                          #
#########################################################################################

set -Eeuo pipefile # stop on error

# [VARIABLE]
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)
echo "SCRIPT_DIR = "${SCRIPT_DIR}
APP='"$$APPLICATION_NAME"'
VERSION='"$$VERSION"'
EXT=rse
COMMENT='"$$DESCRIPTION"'
EXEC=/usr/bin/$APP
LOGO=./icons/hicolor/48x48/rsised.png
ICONS_PATH="/usr/share/icons/hicolor"
DESKTOP_PATH="/usr/share/applications"
INSTALL_PATH="/opt/rsised"
LINK_PATH="/usr/bin/rsised"

# cleanup() {
#}

# trap cleanup SIGINT SIGTERM ERR # Clearing when signals are received

echo '"rsised install..."'

# [CHECK USER]
if [[ $EUID -ne 0 ]]; then
    echo '"This script must be run as root"'
    exit 1
fi

# [REMOVE OLD VERSION]
if [ -d $INSTALL_PATH ]; then
    $INSTALL_PATH'/uninstall.sh' > /dev/null
fi

xdg-icon-resource install --context mimetypes --size 48 $LOGO application-x-$APP

echo '"<?xml version=\"1.0\" encoding=\"UTF-8\"?>'
<mime-info xmlns=\"http://www.freedesktop.org/standards/shared-mime-info\">
    <mime-type type=\"application/x-$APP\">
        <comment>$COMMENT</comment>
        <icon name=\"application-x-$APP\"/>
        <glob pattern=\"*.$EXT\"/>
    </mime-type>
'</mime-info>"' > $APP-mime.xml

xdg-mime install $APP-mime.xml
rm $APP-mime.xml
update-mime-database $HOME/.local/share/mime

mkdir -v $INSTALL_PATH
cp -v rsised.sh $INSTALL_PATH
chmod u+x uninstall.sh
cp -v uninstall.sh $INSTALL_PATH
cp -rv plugins $INSTALL_PATH
cp -rv lib $INSTALL_PATH
cp -rv bin $INSTALL_PATH
cp -v rsised.desktop $DESKTOP_PATH
ln -sv $INSTALL_PATH'/rsised.sh' $LINK_PATH
chmod a+x $LINK_PATH
echo '"---"'
cp -v icons/hicolor/32x32/rsised.png $ICONS_PATH'/32x32/apps'
cp -v icons/hicolor/48x48/rsised.png $ICONS_PATH'/48x48/apps'
cp -v icons/hicolor/64x64/rsised.png $ICONS_PATH'/64x64/apps'
cp -v icons/hicolor/72x72/rsised.png $ICONS_PATH'/72x72/apps'
cp -v icons/hicolor/96x96/rsised.png $ICONS_PATH'/96x96/apps'
cp -v icons/hicolor/128x128/rsised.png $ICONS_PATH'/128x128/apps'
cp -v icons/hicolor/256x256/rsised.png $ICONS_PATH'/256x256/apps'
cp -v icons/hicolor/512x512/rsised.png $ICONS_PATH'/512x512/apps'
cp -v icons/hicolor/scalable/rsised.svg $ICONS_PATH'/scalable/apps'

gtk-update-icon-cache $ICONS_PATH
update-desktop-database $DESKTOP_PATH
xdg-mime default $APP.desktop application/x-$APP

echo '"...finished!"'
